<?php
/**
 * Sistema de Boletos IMED - API Debug de Matr√≠cula
 * Arquivo: admin/api/debug-matricula.php
 * 
 * Esta API ajuda a diagnosticar problemas de matr√≠cula
 */

session_start();

if (!isset($_SESSION['admin_id'])) {
    http_response_code(401);
    echo json_encode(['success' => false, 'message' => 'N√£o autenticado']);
    exit;
}

header('Content-Type: application/json');

require_once '../../config/database.php';
require_once '../../config/moodle.php';
require_once '../../src/MoodleAPI.php';
require_once '../../src/AlunoService.php';

try {
    $input = json_decode(file_get_contents('php://input'), true);
    $cpf = preg_replace('/[^0-9]/', '', $input['cpf'] ?? '');
    $polo = $input['polo'] ?? '';
    $acao = $input['acao'] ?? 'verificar';
    
    if (empty($cpf) || strlen($cpf) !== 11) {
        throw new Exception('CPF inv√°lido');
    }
    
    if (empty($polo)) {
        throw new Exception('Polo √© obrigat√≥rio');
    }
    
    $db = (new Database())->getConnection();
    $resultado = [
        'success' => true,
        'cpf' => $cpf,
        'polo' => $polo,
        'acao' => $acao,
        'timestamp' => date('Y-m-d H:i:s'),
        'debug' => []
    ];
    
    error_log("DEBUG MATR√çCULA: Iniciando para CPF {$cpf}, Polo {$polo}, A√ß√£o: {$acao}");
    
    // 1. VERIFICA ALUNO NO SISTEMA LOCAL
    $resultado['debug'][] = "=== VERIFICA√á√ÉO NO SISTEMA LOCAL ===";
    
    $stmt = $db->prepare("
        SELECT id, nome, cpf, email, subdomain, moodle_user_id, created_at, updated_at
        FROM alunos 
        WHERE cpf = ? AND subdomain = ?
    ");
    $stmt->execute([$cpf, $polo]);
    $alunoLocal = $stmt->fetch(PDO::FETCH_ASSOC);
    
    if ($alunoLocal) {
        $resultado['aluno_local'] = $alunoLocal;
        $resultado['debug'][] = "‚úÖ Aluno encontrado no sistema local";
        $resultado['debug'][] = "   - ID: {$alunoLocal['id']}";
        $resultado['debug'][] = "   - Nome: {$alunoLocal['nome']}";
        $resultado['debug'][] = "   - Moodle User ID: {$alunoLocal['moodle_user_id']}";
        $resultado['debug'][] = "   - √öltima atualiza√ß√£o: {$alunoLocal['updated_at']}";
    } else {
        $resultado['aluno_local'] = null;
        $resultado['debug'][] = "‚ùå Aluno N√ÉO encontrado no sistema local";
    }
    
    // 2. BUSCA MATR√çCULAS LOCAIS
    if ($alunoLocal) {
        $resultado['debug'][] = "\n=== MATR√çCULAS NO SISTEMA LOCAL ===";
        
        $stmt = $db->prepare("
            SELECT m.*, c.nome as curso_nome, c.moodle_course_id, c.subdomain as curso_subdomain
            FROM matriculas m
            INNER JOIN cursos c ON m.curso_id = c.id
            WHERE m.aluno_id = ?
            ORDER BY m.created_at DESC
        ");
        $stmt->execute([$alunoLocal['id']]);
        $matriculasLocais = $stmt->fetchAll(PDO::FETCH_ASSOC);
        
        $resultado['matriculas_locais'] = $matriculasLocais;
        
        if (!empty($matriculasLocais)) {
            $resultado['debug'][] = "‚úÖ Encontradas " . count($matriculasLocais) . " matr√≠culas";
            
            foreach ($matriculasLocais as $matricula) {
                $resultado['debug'][] = "   üìö {$matricula['curso_nome']}";
                $resultado['debug'][] = "      - Curso ID: {$matricula['curso_id']}";
                $resultado['debug'][] = "      - Moodle Course ID: {$matricula['moodle_course_id']}";
                $resultado['debug'][] = "      - Status: {$matricula['status']}";
                $resultado['debug'][] = "      - Polo: {$matricula['curso_subdomain']}";
                $resultado['debug'][] = "      - Data matr√≠cula: {$matricula['data_matricula']}";
            }
        } else {
            $resultado['debug'][] = "‚ùå Nenhuma matr√≠cula encontrada no sistema local";
        }
    }
    
    // 3. VERIFICA NO MOODLE
    $resultado['debug'][] = "\n=== VERIFICA√á√ÉO NO MOODLE ===";
    
    try {
        $moodleAPI = new MoodleAPI($polo);
        
        // Testa conex√£o
        $testeConexao = $moodleAPI->testarConexao();
        if ($testeConexao['sucesso']) {
            $resultado['debug'][] = "‚úÖ Conex√£o com Moodle OK";
            $resultado['debug'][] = "   - Site: {$testeConexao['nome_site']}";
            $resultado['debug'][] = "   - Vers√£o: {$testeConexao['versao']}";
        } else {
            $resultado['debug'][] = "‚ùå Erro na conex√£o: {$testeConexao['erro']}";
            $resultado['moodle_conectado'] = false;
        }
        
        // Busca aluno no Moodle
        $alunoMoodle = $moodleAPI->buscarAlunoPorCPF($cpf);
        
        if ($alunoMoodle) {
            $resultado['aluno_moodle'] = $alunoMoodle;
            $resultado['debug'][] = "‚úÖ Aluno encontrado no Moodle";
            $resultado['debug'][] = "   - Nome: {$alunoMoodle['nome']}";
            $resultado['debug'][] = "   - Email: {$alunoMoodle['email']}";
            $resultado['debug'][] = "   - Moodle User ID: {$alunoMoodle['moodle_user_id']}";
            $resultado['debug'][] = "   - Cursos encontrados: " . count($alunoMoodle['cursos']);
            
            if (!empty($alunoMoodle['cursos'])) {
                $resultado['debug'][] = "\nüìö CURSOS NO MOODLE:";
                foreach ($alunoMoodle['cursos'] as $curso) {
                    $resultado['debug'][] = "   - {$curso['nome']} (ID: {$curso['moodle_course_id']})";
                }
            }
        } else {
            $resultado['aluno_moodle'] = null;
            $resultado['debug'][] = "‚ùå Aluno N√ÉO encontrado no Moodle";
        }
        
    } catch (Exception $e) {
        $resultado['debug'][] = "‚ùå Erro ao conectar com Moodle: " . $e->getMessage();
        $resultado['moodle_erro'] = $e->getMessage();
    }
    
    // 4. BUSCA CURSOS DISPON√çVEIS NO POLO
    $resultado['debug'][] = "\n=== CURSOS DISPON√çVEIS NO POLO ===";
    
    $stmt = $db->prepare("
        SELECT id, nome, nome_curto, moodle_course_id, ativo
        FROM cursos 
        WHERE subdomain = ? AND ativo = 1
        ORDER BY nome
    ");
    $stmt->execute([$polo]);
    $cursosDisponiveis = $stmt->fetchAll(PDO::FETCH_ASSOC);
    
    $resultado['cursos_disponiveis'] = $cursosDisponiveis;
    
    if (!empty($cursosDisponiveis)) {
        $resultado['debug'][] = "‚úÖ Encontrados " . count($cursosDisponiveis) . " cursos dispon√≠veis";
        foreach ($cursosDisponiveis as $curso) {
            $resultado['debug'][] = "   üìñ {$curso['nome']} (ID Local: {$curso['id']}, Moodle ID: {$curso['moodle_course_id']})";
        }
    } else {
        $resultado['debug'][] = "‚ùå Nenhum curso dispon√≠vel encontrado para este polo";
    }
    
    // 5. A√á√ïES ESPECIAIS
    if ($acao === 'sincronizar' && isset($alunoMoodle)) {
        $resultado['debug'][] = "\n=== SINCRONIZA√á√ÉO FOR√áADA ===";
        
        try {
            $alunoService = new AlunoService();
            $alunoId = $alunoService->salvarOuAtualizarAluno($alunoMoodle);
            
            $resultado['debug'][] = "‚úÖ Sincroniza√ß√£o realizada com sucesso";
            $resultado['debug'][] = "   - Aluno ID: {$alunoId}";
            $resultado['sincronizacao_realizada'] = true;
            
            // Busca matr√≠culas atualizadas
            $stmt = $db->prepare("
                SELECT m.*, c.nome as curso_nome
                FROM matriculas m
                INNER JOIN cursos c ON m.curso_id = c.id
                WHERE m.aluno_id = ?
            ");
            $stmt->execute([$alunoId]);
            $matriculasAtualizadas = $stmt->fetchAll(PDO::FETCH_ASSOC);
            
            $resultado['matriculas_apos_sincronizacao'] = $matriculasAtualizadas;
            $resultado['debug'][] = "   - Matr√≠culas ap√≥s sincroniza√ß√£o: " . count($matriculasAtualizadas);
            
        } catch (Exception $e) {
            $resultado['debug'][] = "‚ùå Erro na sincroniza√ß√£o: " . $e->getMessage();
            $resultado['sincronizacao_erro'] = $e->getMessage();
        }
    }
    
    // 6. DIAGN√ìSTICO FINAL
    $resultado['debug'][] = "\n=== DIAGN√ìSTICO FINAL ===";
    
    if (!$alunoLocal && !isset($alunoMoodle)) {
        $resultado['diagnostico'] = 'ALUNO_NAO_ENCONTRADO';
        $resultado['debug'][] = "üî¥ PROBLEMA: Aluno n√£o encontrado nem no sistema local nem no Moodle";
        $resultado['debug'][] = "   SOLU√á√ÉO: Verificar se o CPF est√° correto e se o aluno est√° realmente matriculado no Moodle";
    } elseif (!$alunoLocal && isset($alunoMoodle)) {
        $resultado['diagnostico'] = 'ALUNO_NAO_SINCRONIZADO';
        $resultado['debug'][] = "üü° PROBLEMA: Aluno existe no Moodle mas n√£o est√° sincronizado no sistema local";
        $resultado['debug'][] = "   SOLU√á√ÉO: Execute a sincroniza√ß√£o for√ßada ou fa√ßa login no sistema";
    } elseif ($alunoLocal && empty($matriculasLocais)) {
        $resultado['diagnostico'] = 'SEM_MATRICULAS';
        $resultado['debug'][] = "üü° PROBLEMA: Aluno existe mas n√£o possui matr√≠culas ativas";
        $resultado['debug'][] = "   SOLU√á√ÉO: Verificar se o aluno est√° matriculado em algum curso no Moodle";
    } elseif ($alunoLocal && !empty($matriculasLocais)) {
        $resultado['diagnostico'] = 'TUDO_OK';
        $resultado['debug'][] = "üü¢ STATUS: Tudo parece estar correto";
        $resultado['debug'][] = "   - Aluno existe no sistema";
        $resultado['debug'][] = "   - Possui " . count($matriculasLocais) . " matr√≠cula(s) ativa(s)";
    }
    
    // 7. SUGEST√ïES
    $resultado['sugestoes'] = [];
    
    if (!isset($alunoMoodle)) {
        $resultado['sugestoes'][] = "Verificar se o CPF est√° correto no Moodle";
        $resultado['sugestoes'][] = "Verificar se o aluno est√° matriculado no polo correto";
    }
    
    if (empty($cursosDisponiveis)) {
        $resultado['sugestoes'][] = "Sincronizar cursos do polo usando a API de buscar cursos";
    }
    
    if ($alunoLocal && empty($matriculasLocais) && isset($alunoMoodle)) {
        $resultado['sugestoes'][] = "Executar sincroniza√ß√£o for√ßada para atualizar matr√≠culas";
    }
    
    echo json_encode($resultado);
    
} catch (Exception $e) {
    error_log("Erro na API debug matr√≠cula: " . $e->getMessage());
    
    http_response_code(500);
    echo json_encode([
        'success' => false,
        'message' => $e->getMessage(),
        'debug' => [
            'erro_detalhado' => $e->getMessage(),
            'linha' => $e->getLine(),
            'arquivo' => basename($e->getFile())
        ]
    ]);
}
?>